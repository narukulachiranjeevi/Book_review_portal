{% extends 'base.html' %}
{% load stars_filter %}

{% block content %}

<div class="row">
  <div class="col-lg-3">
      Fixed content
      <div class="sticky-top">
        <div class="card" style="max-width: 18rem;">
          <img class="card-img-top" src="{{ book.cover_image.url }}" alt="Card image cap">
          <div class="card-body">
            <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
          </div>
        </div>
      </div>
  </div>
  <div class="col-lg-9">
    <span class="heading">User Rating</span>
    {{ book.get_rating_values|stars }}
    <hr style="border:3px solid #f1f1f1">
    <div class="rows">{{ book.get_rating_values|barchart }}</div>
    <h1>{{book.title}}</h1>
    <h5>{{book.author}}</h5>
    <form action="{% url 'createreview' bookId=book.id %}" method="post">
        {% csrf_token %}
        <div class="rating mr-auto">
            <input type="radio" id="star5" name="rating" value="5" />
            <label class="star" for="star5" title="Awesome" aria-hidden="true"></label>
            <input type="radio" id="star4" name="rating" value="4" />
            <label class="star" for="star4" title="Great" aria-hidden="true"></label>
            <input type="radio" id="star3" name="rating" value="3" />
            <label class="star" for="star3" title="Very good" aria-hidden="true"></label>
            <input type="radio" id="star2" name="rating" value="2" />
            <label class="star" for="star2" title="Good" aria-hidden="true"></label>
            <input type="radio" id="star1" name="rating" value="1" />
            <label class="star" for="star1" title="Bad" aria-hidden="true"></label>
          </div>
        <label for="message">Enter your message:</label><br>
        <textarea class="form-control" id="message" name="review" rows="4" cols="50" value="{{review_form.review}}" required></textarea><br>
        
        <!-- Submit Button -->
        <input type="submit" value="Submit">
    </form>
    <p>
      This book was posted by {{book.user}}
      
    </p>
    <p>hey {{book.reviews.all}}</p>
    
    {% for review in book.review.all %}
      <div class="comments-container">
        <div class="comment">
            <div class="comment-text">
                <a href="{% url 'profile' pk=review.reviewedUser.id %}">
                    <div style="cursor: pointer; color: blue; text-decoration: underline;">
                        {% if review.reviewedUser.profile.profile_pic %}
                            <img class="user-profile" src="{{review.reviewedUser.profile.profile_pic.url}}" alt="User Avatar">
                        {% else %}
                            <div class="user-profile"></div>
                        {% endif %}
                        <span class="user-name">{{review.reviewedUser}}:</span> 
                    </div>
                </a>
                {{review.review}}
                {{ review.rating |rating }}
                <div class="reply-button">Reply</div>
                <div class="load-replies-button" data-review-id="{{review.id}}">Load Replies</div>
                {% if request.user.is_superuser %}
                    <div class="delete-botton" data-review-id="{{review.id}}"><a href="{% url 'reviewDelete' pk=review.id %}">Delete Review</a></div>
                {% endif %}
                <div class="replies">   
                </div>
                <div class="reply-form" style="display: none;">
                  {{user.username}}
                    <form>
                        <input type="hidden" id="user-name" name="repliedUser" value="{{ user.id }}">
                        <input type="hidden" id="user-comment" name="review" value="{{ review.id }}">
                        <textarea class="reply-form-textarea" name="reply" placeholder="Your reply">{{ review.reviewreply }}</textarea>
                        {% if user.is_authenticated %} 
                            <button class="submit-reply">Submit</button>
                        {% else %}
                        You are not logged in.<a href="{% url 'login' %}">Login</a> By link
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    
    </div>
</div>

{% endblock %}
{% block js %}
<script>
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            // Check if this cookie is the one we're looking for
            if (cookie.substring(0, name.length + 1) === name + '=') {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

  $(document).ready(function() {
      // Load Replies Button Click
      $(".load-replies-button").click(function() {
        console.log('called')
          const repliesContainer = $(this).siblings(".replies");
          const reviewId = $(this).data("review-id");
          console.log(reviewId)
          // Send an AJAX request to fetch replies
          $.ajax({
              url: `/books/review/${reviewId}/getreplies`, // Replace with your actual endpoint
              type: "GET",
              dataType: "json",
              success: function(data) {
                  // Clear existing replies
                  repliesContainer.empty();
                  console.log(data)
                  // Iterate through the fetched replies and append them to the container
                  $.each(data, function(index, reply) {
                      const replyElement = `
                          <div class="sample-reply">
                            <img class="user-profile" src="{{reply.reviewreply.profile.profile_pic.url}}" alt="User Avatar">
                              <span class="user-name">${reply.reviewreply}:</span> ${reply.reply}
                          </div>`;
                      repliesContainer.append(replyElement);
                  });
                  if(data.length==0){
                    const replyElement = `
                          <div class="sample-reply">
                              <span class="user-name">No replies</span>
                          </div>`;
                      repliesContainer.append(replyElement);
                  }
                  // Show the replies container
                  repliesContainer.show();
              },
              error: function(error) {
                  console.error("An error occurred:", error);
                      repliesContainer.append(replyElement);
              }
          });
      });
  
      // Reply Button Click
      $(".reply-button").click(function() {
          const replyForm = $(this).siblings(".reply-form");
          replyForm.toggle(); // Toggle the visibility of the reply form
      });
  
      // Submit Reply Button Click (You can adapt this part to your specific form)
      $(".submit-reply").click(function(e) {
          e.preventDefault(); // Prevent the default form submission
  
          const replyForm = $(this).closest("form");
          const formData = replyForm.serialize(); // Serialize form data
          console.log(formData)
          // Send an AJAX request to submit the reply 
          $.ajax({
              url: "/books/replies/create/", // Replace with your actual endpoint
              type: "POST",
              data: formData,
              dataType: "json",
              headers: {
                  'X-CSRFToken': getCookie('csrftoken')  // Include the CSRF token
              },
              success: function(response) {
                  // Handle the response (e.g., display a success message)
                  console.log("Reply submitted successfully:", response);
                  replyForm.toggle();
                  // You may also clear the form or update the replies section
              },
              error: function(error) {
                  console.error("An error occurred:", error);
              }
          });
          
      });
  });
  </script>
  

{% endblock %}
